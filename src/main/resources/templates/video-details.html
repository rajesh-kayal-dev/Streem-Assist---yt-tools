<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Data Retriever</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#2563eb',
                            600: '#1d4ed8',
                            700: '#1d4ed8'
                        },
                        accent: '#22c55e'
                    }
                }
            }
        }
    </script>
    <style>
        .main-title {
            background: linear-gradient(90deg, #2563eb, #22c55e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .gradient-header {
            background: linear-gradient(135deg, rgba(37,99,235,.08), rgba(34,197,94,.08));
            border: 1px dashed #e2e8f0;
        }
        .thumb-box {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .desc-box {
            background: rgba(148,163,184,0.12);
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            min-height: 80px;
            white-space: pre-wrap;
            color: #1e293b;
            transition: all 0.3s ease;
            max-height: 200px;
            overflow-y: auto;
        }
        .tag {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid #e2e8f0;
            transition: transform .1s ease, background .2s ease;
        }
        .tag:hover {
            transform: translateY(-1px);
            background: rgba(34, 197, 94, 0.22);
        }
        .error {
            background: rgba(239, 68, 68, 0.12);
            color: #ef4444;
            border-left: 4px solid #ef4444;
        }
        .success {
            background: rgba(16, 185, 129, 0.12);
            color: #10b981;
            border-left: 4px solid #10b981;
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dark .gradient-header {
            border-color: #334155;
        }
        .dark .thumb-box {
            border-color: #334155;
        }
        .dark .desc-box {
            background: rgba(148,163,184,0.08);
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .tag {
            border-color: #334155;
        }

        /* Modal animations */
        #downloadModal, #downloadingModal {
            animation: fadeIn 0.3s ease-out;
        }

        #downloadModal > div, #downloadingModal > div {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .download-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark .download-option:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100">

<div th:replace="~{fragments/navbar :: navbar}" th:with="activePage='video'"></div>

<div class="container mx-auto px-4 max-w-4xl mt-12 pb-12">
    <div class="text-center mb-8">
        <h1 class="main-title text-4xl md:text-5xl font-extrabold mb-4">YouTube Video Data Retriever</h1>
        <div class="gradient-header rounded-xl p-4 mt-6">
            <p class="text-slate-600 dark:text-slate-400 text-lg mb-0">
                Enter a YouTube video URL or ID to fetch complete video information including title, description, tags, and thumbnail.
            </p>
        </div>
    </div>

    <!-- Form Section -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg p-6 mb-8">
        <form th:action="@{/youtube/video-details}" method="post" id="videoForm">
            <div class="mb-6">
                <label for="videoUrlOrId" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    YouTube Video URL or ID
                </label>
                <input
                        type="text"
                        id="videoUrlOrId"
                        name="videoUrlOrId"
                        th:value="${videoUrlOrId}"
                        class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-800 transition-colors duration-200"
                        placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ or dQw4w9WgXcQ"
                        required>
            </div>
            <button
                    type="submit"
                    id="fetchBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white font-medium py-3 px-6 rounded-lg shadow-lg transition-colors duration-200 flex items-center justify-center gap-2">
                <div id="btnSpinner" class="loading-spinner hidden"></div>
                <span id="btnText">Fetch Video Data</span>
            </button>
        </form>

        <!-- Error Display -->
        <div th:if="${error}" class="error rounded-lg p-4 mt-4">
            <div class="flex items-center gap-2">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span th:text="${error}"></span>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div th:if="${videoDetails}" class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-lg p-6 mb-8"
         data-video-id="" th:data-video-id="${videoDetails.id}"
         data-video-title="" th:data-video-title="${videoDetails.title}">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Thumbnail Section -->
            <div>
                <div class="thumb-box mb-4">
                    <img th:src="${videoDetails.thumbnailUrl}"
                         th:alt="${videoDetails.title}"
                         class="w-full h-auto block"
                         onerror="this.onerror=null;this.src='https://via.placeholder.com/1280x720?text=Thumbnail+Not+Available';">
                </div>
                <div class="flex justify-between items-center">
                    <a th:href="${'https://www.youtube.com/watch?v=' + videoDetails.id}"
                       target="_blank"
                       class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2">
                        <i class="bi bi-youtube"></i> Watch on YouTube
                    </a>
                    <button onclick="openDownloadModal()"
                            class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center gap-2">
                        <i class="bi bi-download"></i> Download Options
                    </button>
                </div>
            </div>

            <!-- Video Info Section -->
            <div class="space-y-6">

                <!-- Title -->
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100 text-lg">
                            <i class="bi bi-film text-blue-500"></i> Title
                        </h2>
                        <button class="copy-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors duration-200 flex items-center gap-1"
                                data-copy-text="" th:data-copy-text="${videoDetails.title}">
                            <i class="bi bi-clipboard text-xs"></i> Copy
                        </button>
                    </div>
                    <div class="text-slate-800 dark:text-slate-200 font-medium"
                         th:text="${videoDetails.title != null ? videoDetails.title : 'No title available'}">
                    </div>
                </div>

                <!-- Channel and Date -->
                <div class="flex flex-wrap items-center gap-4 text-slate-600 dark:text-slate-400">
                    <div class="flex items-center gap-2">
                        <i class="bi bi-person-video"></i>
                        <span th:text="${videoDetails.channelTitle != null ? videoDetails.channelTitle : 'Unknown Channel'}"></span>
                    </div>
                    <div class="flex items-center gap-2" th:if="${videoDetails.publishedAt}">
                        <i class="bi bi-calendar3"></i>
                        <span th:text="${videoDetails.publishedAt}"></span>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100">
                            <i class="bi bi-text-paragraph text-blue-500"></i> Description
                        </h3>
                        <button class="copy-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors duration-200 flex items-center gap-1"
                                data-copy-text="" th:data-copy-text="${videoDetails.description}">
                            <i class="bi bi-clipboard2 text-xs"></i> Copy
                        </button>
                    </div>
                    <div class="desc-box"
                         th:text="${videoDetails.description != null ? videoDetails.description : 'No description available.'}">
                    </div>
                </div>

                <!-- Tags -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="flex items-center gap-2 font-bold text-slate-900 dark:text-slate-100">
                            <i class="bi bi-tags text-blue-500"></i>
                            Tags
                            <span class="text-sm font-normal text-slate-500 dark:text-slate-400"
                                  th:if="${videoDetails.tags != null and !#lists.isEmpty(videoDetails.tags)}"
                                  th:text="'(' + ${#lists.size(videoDetails.tags)} + ')'"></span>
                        </h3>
                        <button class="copy-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors duration-200 flex items-center gap-1"
                                th:if="${videoDetails.tags != null and !#lists.isEmpty(videoDetails.tags)}"
                                data-copy-text="" th:data-copy-text="${#strings.listJoin(videoDetails.tags, ', ')}">
                            <i class="bi bi-clipboard2-check text-xs"></i> Copy All
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2" th:if="${videoDetails.tags != null and !#lists.isEmpty(videoDetails.tags)}">
                        <span th:each="tag : ${videoDetails.tags}"
                              class="tag inline-flex items-center gap-1 rounded-full px-3 py-2 text-sm">
                            <i class="bi bi-hash text-xs"></i>
                            <span th:text="${tag}"></span>
                        </span>
                    </div>
                    <div th:unless="${videoDetails.tags != null and !#lists.isEmpty(videoDetails.tags)}"
                         class="text-slate-500 dark:text-slate-400 italic">
                        No tags available for this video.
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div id="downloadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto">

            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                    <i class="bi bi-download text-green-500"></i>
                    Download Options
                </h3>
                <button onclick="closeDownloadModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 text-xl">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <!-- Video Title -->
                <div class="mb-6 p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-1">Downloading:</p>
                    <p class="font-medium text-slate-900 dark:text-slate-100 text-sm" id="modalVideoTitle">
                        Video Title Will Appear Here
                    </p>
                </div>

                <!-- Video Options -->
                <div class="mb-6">
                    <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-3 flex items-center gap-2">
                        <i class="bi bi-camera-video text-blue-500"></i>
                        Video (MP4)
                    </h4>
                    <div class="space-y-2">
                        <button onclick="downloadVideo('144p')"
                                class="download-option w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg transition-colors duration-200">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-play-circle text-slate-500"></i>
                                144p (Low Quality)
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">~10-20 MB</span>
                        </button>

                        <button onclick="downloadVideo('360p')"
                                class="download-option w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg transition-colors duration-200">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-play-circle text-slate-500"></i>
                                360p (Standard)
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">~30-50 MB</span>
                        </button>

                        <button onclick="downloadVideo('720p')"
                                class="download-option w-full flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors duration-200 border border-blue-200 dark:border-blue-800">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-play-circle text-blue-500"></i>
                                720p HD (Recommended)
                            </span>
                            <span class="text-xs text-blue-600 dark:text-blue-400">~100-150 MB</span>
                        </button>

                        <button onclick="downloadVideo('1080p')"
                                class="download-option w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg transition-colors duration-200">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-play-circle text-slate-500"></i>
                                1080p Full HD
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">~200-300 MB</span>
                        </button>

                        <button onclick="downloadVideo('4k')"
                                class="download-option w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg transition-colors duration-200">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-play-circle text-slate-500"></i>
                                4K Ultra HD
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">~500MB-1GB</span>
                        </button>
                    </div>
                </div>

                <!-- Audio Options -->
                <div>
                    <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-3 flex items-center gap-2">
                        <i class="bi bi-music-note text-green-500"></i>
                        Audio Only
                    </h4>
                    <div class="space-y-2">
                        <button onclick="downloadAudio('mp3')"
                                class="download-option w-full flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors duration-200 border border-green-200 dark:border-green-800">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-file-earmark-music text-green-500"></i>
                                MP3 (High Quality)
                            </span>
                            <span class="text-xs text-green-600 dark:text-green-400">~5-10 MB</span>
                        </button>

                        <button onclick="downloadAudio('m4a')"
                                class="download-option w-full flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-lg transition-colors duration-200">
                            <span class="flex items-center gap-2">
                                <i class="bi bi-file-earmark-music text-slate-500"></i>
                                M4A (Apple Format)
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400">~4-8 MB</span>
                        </button>
                    </div>
                </div>

                <!-- Legal Notice -->
                <div class="mt-6 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                    <div class="flex items-start gap-2">
                        <i class="bi bi-exclamation-triangle text-yellow-600 dark:text-yellow-400 mt-0.5"></i>
                        <div class="text-xs text-yellow-800 dark:text-yellow-300">
                            <p class="font-medium mb-1">Legal Notice</p>
                            <p>Please respect copyright laws and YouTube's Terms of Service. Only download content you have permission to use.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="downloadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-2xl p-8 text-center max-w-sm w-full">
            <div class="loading-spinner mx-auto mb-4" style="width: 48px; height: 48px; border: 4px solid #f3f4f6; border-top: 4px solid #2563eb;"></div>
            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Preparing Download</h3>
            <p class="text-slate-600 dark:text-slate-400 text-sm">Please wait while we process your request...</p>
            <div class="mt-4">
                <button onclick="cancelDownload()"
                        class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Copy Success Message -->
    <div id="copySuccess" class="success hidden rounded-lg p-4 mb-4 flex items-center gap-2">
        <i class="bi bi-check-circle-fill"></i>
        <span>Successfully copied to clipboard!</span>
    </div>
</div>

<script>
    // Global variables to store video info
    let currentVideoId = '';
    let currentVideoTitle = '';

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Get video details from data attributes
        const videoDetailsElement = document.querySelector('[data-video-id]');
        if (videoDetailsElement) {
            currentVideoId = videoDetailsElement.getAttribute('data-video-id');
            currentVideoTitle = videoDetailsElement.getAttribute('data-video-title');
        }
    });

    // Form submission with loading state
    const form = document.getElementById('videoForm');
    const fetchBtn = document.getElementById('fetchBtn');
    const btnSpinner = document.getElementById('btnSpinner');
    const btnText = document.getElementById('btnText');

    form.addEventListener('submit', function() {
        fetchBtn.disabled = true;
        btnSpinner.classList.remove('hidden');
        btnText.textContent = 'Fetching...';
    });

    // Download Modal Functions
    function openDownloadModal() {
        const modal = document.getElementById('downloadModal');
        const modalTitle = document.getElementById('modalVideoTitle');

        // Set video title in modal
        if (currentVideoTitle) {
            modalTitle.textContent = currentVideoTitle;
        }

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeDownloadModal() {
        const modal = document.getElementById('downloadModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    function showDownloadingModal() {
        const modal = document.getElementById('downloadingModal');
        modal.classList.remove('hidden');
    }

    function hideDownloadingModal() {
        const modal = document.getElementById('downloadingModal');
        modal.classList.add('hidden');
    }

    function downloadVideo(quality) {
        if (!currentVideoId) {
            alert('Video ID not found. Please try again.');
            return;
        }

        closeDownloadModal();
        showDownloadingModal();

        // Create download URL with proper filename
        const filename = sanitizeFilename(currentVideoTitle || 'youtube_video');
        const downloadUrl = `/download?videoId=${encodeURIComponent(currentVideoId)}&format=video&quality=${encodeURIComponent(quality)}&filename=${encodeURIComponent(filename)}`;

        // Trigger download after a short delay
        setTimeout(() => {
            window.location.href = downloadUrl;
            hideDownloadingModal();
            showDownloadSuccess(`${quality} video download started`);
        }, 2000);
    }

    function downloadAudio(format) {
        if (!currentVideoId) {
            alert('Video ID not found. Please try again.');
            return;
        }

        closeDownloadModal();
        showDownloadingModal();

        // Create download URL with proper filename
        const filename = sanitizeFilename(currentVideoTitle || 'youtube_audio');
        const downloadUrl = `/download?videoId=${encodeURIComponent(currentVideoId)}&format=audio&quality=${encodeURIComponent(format)}&filename=${encodeURIComponent(filename)}`;

        // Trigger download after a short delay
        setTimeout(() => {
            window.location.href = downloadUrl;
            hideDownloadingModal();
            showDownloadSuccess(`${format.toUpperCase()} audio download started`);
        }, 2000);
    }

    function cancelDownload() {
        hideDownloadingModal();
    }

    function sanitizeFilename(filename) {
        // Remove invalid characters for filenames
        return filename.replace(/[<>:"/\\|?*]/g, '_')
                      .replace(/\s+/g, '_')
                      .substring(0, 100);
    }

    function showDownloadSuccess(message) {
        const successDiv = document.getElementById('copySuccess');
        if (successDiv) {
            successDiv.querySelector('span').textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 4000);
        }
    }

    // Copy functionality - simplified
    const copySuccess = document.getElementById('copySuccess');

    document.addEventListener('click', function(e) {
        if (e.target.closest('.copy-btn')) {
            const btn = e.target.closest('.copy-btn');
            const textToCopy = btn.getAttribute('data-copy-text');

            if (!textToCopy || textToCopy.trim() === '') {
                alert('No content to copy');
                return;
            }

            navigator.clipboard.writeText(textToCopy.trim())
                .then(() => {
                    copySuccess.querySelector('span').textContent = 'Content copied to clipboard!';
                    copySuccess.classList.remove('hidden');
                    setTimeout(() => {
                        copySuccess.classList.add('hidden');
                    }, 3000);
                })
                .catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy.trim();
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copySuccess.querySelector('span').textContent = 'Content copied to clipboard!';
                        copySuccess.classList.remove('hidden');
                        setTimeout(() => {
                            copySuccess.classList.add('hidden');
                        }, 3000);
                    } catch (err) {
                        alert('Could not copy content.');
                    }
                    document.body.removeChild(textArea);
                });
        }
    });

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const downloadModal = document.getElementById('downloadModal');
        if (e.target === downloadModal) {
            closeDownloadModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDownloadModal();
            hideDownloadingModal();
        }
    });

    // Theme detection
    if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
    }
</script>

</body>
</html>